<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Massager Chat</title>
    <style>
        /* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            gap: 20px;
        }

        .auth-section, .chat-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        h2 {
            margin-bottom: 15px;
            color: #555;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .chat-management {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-list {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-y: auto;
            max-height: 400px;
            background-color: #fafafa;
        }

        .chat-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #ddd;
        }

        .chat-item:hover {
            background-color: #f8f9fa;
        }

        .chat-item.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-y: auto;
            max-height: 400px;
            background-color: #fafafa;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 70%;
        }

        .message.own {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.other {
            background-color: #e9ecef;
            color: #333;
        }

        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
        }

        .user-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #28a745;
            font-size: 14px;
            margin-top: 5px;
        }

        .create-chat-form {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .member-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .member-input input {
            flex: 1;
        }

        .member-tag {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí¨ Massager Chat</h1>
        
        <div id="authSection" class="auth-section">
            <div id="loginForm">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="loginUsername">Username:</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button onclick="login()">Login</button>
                <button onclick="showRegisterForm()" style="background-color: #6c757d; margin-left: 10px;">Register</button>
                <div id="loginMessage"></div>
            </div>

            <div id="registerForm" class="hidden">
                <h2>Register</h2>
                <div class="form-group">
                    <label for="registerUsername">Username:</label>
                    <input type="text" id="registerUsername" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password:</label>
                    <input type="password" id="registerPassword" placeholder="Choose a password">
                </div>
                <button onclick="register()">Register</button>
                <button onclick="showLoginForm()" style="background-color: #6c757d; margin-left: 10px;">Back to Login</button>
                <div id="registerMessage"></div>
            </div>
        </div>

        <div id="chatSection" class="chat-section hidden" style="display: flex; width: 100%; gap: 20px;">
            <div class="chat-management">
                <div class="user-info">
                    Welcome, <span id="currentUser"></span>! 
                    <button onclick="logout()" style="background-color: #dc3545; margin-left: 10px;">Logout</button>
                </div>
                
                <div class="create-chat-form">
                    <h3>Create New Chat</h3>
                    <div class="form-group">
                        <label for="chatName">Chat Name:</label>
                        <input type="text" id="chatName" placeholder="Enter chat name">
                    </div>
                    <div class="form-group">
                        <label>Add Members:</label>
                        <div class="member-input">
                            <input type="text" id="memberInput" placeholder="Enter username">
                            <button onclick="addMember()">Add</button>
                        </div>
                        <div id="membersList"></div>
                    </div>
                    <button onclick="createChat()">Create Chat</button>
                    <div id="createChatMessage"></div>
                </div>

                <h3>Your Chats</h3>
                <div id="chatList" class="chat-list">
                </div>
            </div>

            <div class="chat-container" style="flex: 1;">
                <div class="user-info" id="currentChatInfo">
                    Select a chat to start messaging
                </div>
                
                <div id="messages" class="messages"></div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Select a chat to send messages" disabled>
                    <button onclick="sendMessage()" disabled id="sendButton">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentToken = null;
        let currentUsername = null;
        let currentChatId = null;
        let currentMembers = [];
        let userChats = [];

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('loginMessage');

            if (!username || !password) {
                showMessage(messageDiv, 'Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentToken = data.token;
                    currentUsername = username;
                    showChat();
                    loadUserChats();
                    connectWebSocket();
                } else {
                    showMessage(messageDiv, data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage(messageDiv, 'Network error: ' + error.message, 'error');
            }
        }

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const messageDiv = document.getElementById('registerMessage');

            if (!username || !email || !password) {
                showMessage(messageDiv, 'Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password, email })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(messageDiv, 'Registration successful! Please login.', 'success');
                    showLoginForm();
                } else {
                    showMessage(messageDiv, data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage(messageDiv, 'Network error: ' + error.message, 'error');
            }
        }

        function logout() {
            if (ws) {
                ws.close();
            }
            currentToken = null;
            currentUsername = null;
            currentChatId = null;
            showAuth();
            document.getElementById('messages').innerHTML = '';
            document.getElementById('chatList').innerHTML = '';
        }

        async function loadUserChats() {
    if (!currentToken) {
        console.log('No token available for loading chats');
        return;
    }

    try {
        const response = await fetch('/api/chats', {
            headers: {
                'Authorization': `Bearer ${currentToken}`
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Loaded chats:', data.chats);
        
        if (data.chats && Array.isArray(data.chats)) {
            userChats = data.chats; 
            displayChats(userChats);
        } else {
            console.warn('Invalid chats data structure:', data);
            userChats = [];
            displayChats([]);
        }
    } catch (error) {
        console.error('Failed to load chats:', error);
        userChats = []; 
        displayChats([]);
    }
}
    
function joinAllChats() {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.log('WebSocket not ready, retrying in 1 second...');
        setTimeout(joinAllChats, 1000);
        return;
    }
    
    console.log('Joining all chats:', userChats.length);
    userChats.forEach(chat => {
        const joinMessage = {
            type: 'join_chat',
            chat_id: chat.id,
            sender: currentUsername
        };
        ws.send(JSON.stringify(joinMessage));
        console.log('Joined chat:', chat.id, chat.name);
    });
}

        function displayChats(chats) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';

            console.log('Displaying chats:', chats);

            if (chats.length === 0) {
                chatList.innerHTML = '<div style="text-align: center; color: #666;">No chats yet</div>';
                return;
            }

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.textContent = chat.name || `Chat with ${chat.members?.join(', ') || 'others'}`;
                chatItem.onclick = () => selectChat(chat.id, chat.name);
                chatList.appendChild(chatItem);
            });
        }

        function selectChat(chatId, chatName) {
            currentChatId = chatId;
            
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('currentChatInfo').textContent = `Chat: ${chatName}`;
            document.getElementById('messageInput').placeholder = `Message in ${chatName}...`;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            joinChat(chatId);
            
            document.getElementById('messages').innerHTML = '';
            loadChatMessages(chatId);
        }

        async function loadChatMessages(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}/messages?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMessages(data.messages || []);
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        function displayMessages(messages) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';

            messages.forEach(message => {
                const isOwn = message.sender_id === currentUsername;
                addMessage(message.sender_id, message.content, isOwn ? 'own' : 'other');
            });
        }

        function addMember() {
            const memberInput = document.getElementById('memberInput');
            const member = memberInput.value.trim();
            
            if (member && !currentMembers.includes(member)) {
                currentMembers.push(member);
                updateMembersList();
                memberInput.value = '';
            }
        }

        function updateMembersList() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = currentMembers.map(member => 
                `<span class="member-tag">${member}</span>`
            ).join('');
        }

        async function testChatAPI() {
            if (!currentToken) {
                console.log('No token available');
                return;
            }

            try {
                console.log('Testing chats API...');
                
                const response = await fetch('/api/chats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                console.log('Chats endpoint status:', response.status);
                console.log('Chats endpoint content-type:', response.headers.get('content-type'));
                
                const text = await response.text();
                console.log('Chats endpoint response (first 200 chars):', text.substring(0, 200));
                
            } catch (error) {
                console.error('Chat API test failed:', error);
            }
            }

        async function createChat() {
            const chatName = document.getElementById('chatName').value.trim();
            const messageDiv = document.getElementById('createChatMessage');

            if (!chatName) {
                showMessage(messageDiv, 'Please enter chat name', 'error');
                return;
            }

            if (currentMembers.length === 0) {
                showMessage(messageDiv, 'Please add at least one member', 'error');
                return;
            }

            try {
                const response = await fetch('/api/chats', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_name: chatName,
                        member_ids: currentMembers
                    })
                });

                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`Server returned ${response.status}: ${text.substring(0, 100)}`);
                }

                if (response.ok) {
                    showMessage(messageDiv, 'Chat created successfully!', 'success');
                    
                    const membersCopy = [...currentMembers]; 
                    
                    document.getElementById('chatName').value = '';
                    currentMembers = [];
                    updateMembersList();
                    
                    const newChat = {
                        id: data.chat_id,
                        name: chatName,
                        members: membersCopy 
                    };
                    userChats.push(newChat);
                    displayChats(userChats);
                    
                    setTimeout(() => {
                        joinChat(newChat.id);
                    }, 100);
                    
                } else {
                    showMessage(messageDiv, data.error || `Failed to create chat: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('Create chat error:', error);
                showMessage(messageDiv, `Error: ${error.message}`, 'error');
            }
        }

        function notifyMembersAboutNewChat(chat, members) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const notification = {
                type: 'chat_created',
                chat_id: chat.id,
                chat_name: chat.name,
                members: members,
                created_by: currentUsername
            };
            
            ws.send(JSON.stringify(notification));
            console.log('Notified members about new chat:', members);
        }

        function connectWebSocket() {
            if (!currentToken) return;

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws?token=${currentToken}`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket connected successfully');
                addMessage('System', 'Connected to chat', 'other');
                
                joinAllChats();
            };

            ws.onmessage = function(event) {
                console.log('WebSocket message received:', event.data);
                try {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'message') {
                        if (message.sender !== currentUsername) {
                            if (currentChatId && message.chat_id === currentChatId) {
                                addMessage(message.sender, message.content, 'other');
                            }
                        }
                    } 
                    else if (message.type === 'chat_created') {
                        if (message.members && message.members.includes(currentUsername)) {
                            console.log('You were added to new chat:', message.chat_name);
                            
                            const newChat = {
                                id: message.chat_id,
                                name: message.chat_name,
                                members: message.members
                            };
                            
                            if (!userChats.some(chat => chat.id === newChat.id)) {
                                userChats.push(newChat);
                                displayChats(userChats);
                                
                                setTimeout(() => joinChat(newChat.id), 100);
                                
                                showNotification(`You were added to chat: "${message.chat_name}" by ${message.created_by}`);
                            }
                        }
                    }
                } catch (error) {
                    console.log('System message:', event.data);
                }
            };

            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                addMessage('System', 'Disconnected from chat', 'other');
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function joinChat(chatId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const joinMessage = {
                type: 'join_chat',
                chat_id: chatId,
                sender: currentUsername
            };
            ws.send(JSON.stringify(joinMessage));
            console.log('Joined chat:', chatId);
        }

        function showNotification(message) {
            console.log('Notification:', message);
            alert(`üì¢ ${message}`); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        }

        function sendMessage() {
            if (!currentChatId || !ws || ws.readyState !== WebSocket.OPEN) return;

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            const messageData = {
                type: 'message',
                chat_id: currentChatId,
                content: message,
                sender: currentUsername,
                timestamp: new Date().toISOString()
            };

            addMessage(currentUsername, message, 'own');
            
            ws.send(JSON.stringify(messageData));
            input.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function showAuth() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('chatSection').classList.add('hidden');
        }

        function showChat() {
             document.getElementById('authSection').classList.add('hidden');
            document.getElementById('chatSection').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUsername;
    
            setTimeout(() => testChatAPI(), 1000);
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            clearMessages();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            clearMessages();
        }

        function addMessage(sender, text, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const senderSpan = document.createElement('div');
            senderSpan.className = 'message-sender';
            senderSpan.textContent = sender;
            
            const textSpan = document.createElement('div');
            textSpan.textContent = text;
            
            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(textSpan);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = type;
            setTimeout(() => element.textContent = '', 5000);
        }

        function clearMessages() {
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('registerMessage').textContent = '';
        }

        document.getElementById('loginUsername').focus();
    </script>
</body>
</html>